{% extends "structure.html" %}

{% block general_controls %}
    {{ super() }}
    <div class="col">
        <div class="float-right">

            <button class="switch close" id="genome-switch-button"
                    data-trigger="focus"
                    data-toggle="popover"
                    data-placement="left"
                    {# data-content="Select genome build"#} > 
                <input id="genome-switch" class="switch" type="checkbox">
                <label for="genome-switch" id="genome-switch-label" class="">Genome</label>
            </button>
        </div>
    </div>
{% endblock %}

{% block genes_section %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-genes">
        Genes
    </a>
    <div id="collapse-genes" class="form-group collapse show">
        <div class="row">
            <div class="card-body align-self-center col-md-6">
                <div class="form-group">
                    <h5><label for="select-genes">Select genes:</label></h5>
                    <div>
                        <select class="form-control" name="genes" id="select-genes" required></select>
                    </div>
                    <a class="ask-btn small text-success"
                       tabindex="0"
                       role="button"
                       data-trigger="focus"
                       data-toggle="popover"
                       data-placement="right"
                       data-html="true"
                       data-content="Holding [ctrl✲] key will prevent modal dialog from closing after selection">
                        [Tips]
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block tissues_section %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-tissues">
        Organs, tissues and cell types
    </a>
    <div id="collapse-tissues" class="form-group collapse show">
        <div class="row">
            <div class="card-body align-self-center col-md-6">
                <h5><label for="select-tissues">Select organs/tissues/cell types:<br/>
                </label></h5>
                <div>
                    <select class="form-control" name="tissues" id="select-tissues"></select>
                </div>
                <a class="ask-btn small text-success"
                   tabindex="0"
                   role="button"
                   data-trigger="focus"
                   data-toggle="popover"
                   data-placement="right"
                   data-html="true"
                   data-content="Because data is still not fully complete, symbols in parentheses are telling which sections are affected by chosen tissue/organ/cell type: <br /><br />
                                    Legend:<br />

                                    TSS - Transcription start sites <br />
                                    ENH_F5 - Enhancers -> FANTOM5 <br />
                                    ENH_EN - Enhancers -> ENCODE <br />
                                    CHRM - Accessible chromatin">
                    [Meaning of symbols in parentheses]
                </a><br />
                <a class="ask-btn small text-success"
                   tabindex="0"
                   role="button"
                   data-trigger="focus"
                   data-toggle="popover"
                   data-placement="right"
                   data-html="true"
                   data-content="Holding [ctrl✲] key will prevent modal dialog from closing after selection">
                    [Tips]
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block transcription_start_sites %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-transcription-start-sites">
        Transcription start sites
    </a>
    <div id="collapse-transcription-start-sites" class="collapse show">
        <div class="row">
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="transcription-start-sites-fantom5-checkbox">
                        <input id="transcription-start-sites-fantom5-checkbox"
                               name="transcription-fantom5-used"
                               type="checkbox" value="yes">
                        FANTOM5
                    </label>
                    {#                    <a class="ask-btn"#}
                    {#                       tabindex="0"#}
                    {#                       role="button"#}
                    {#                       data-trigger="focus"#}
                    {#                       data-toggle="popover"#}
                    {#                       data-placement="right"#}
                    {#                       data-content="There will be help here">#}
                    {#                        [?]#}
                    {#                    </a>#}
                    <div id="transcription-start-sites-fantom5-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="transcription-fantom5-combine-mode" type="radio"
                                       id="transcription-fantom5-all" value="all" disabled>
                                <label class="form-check-label" for="transcription-fantom5-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="transcription-fantom5-combine-mode" type="radio"
                                       id="transcription-fantom5-any" value="any" checked disabled>
                                <label class="form-check-label" for="transcription-fantom5-any">
                                    Active in any of selected tissues</label>
                            </div>
                            <label for="transcription-fantom5-kbs" class="col-form-label">
                                bps upstream
                                <input name="transcription-fantom5-kbs-upstream" class="form-control" type="number"
                                       min="0" value="3000" id="transcription-fantom5-kbs-upstream" disabled>
                                bps downstream
                                <input name="transcription-fantom5-kbs-downstream" class="form-control" type="number"
                                       min="0" value="100" id="transcription-fantom5-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block enhancers %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-enhancers">
        Enhancers
    </a>
    <div id="collapse-enhancers" class="collapse show">
        <div class="row">
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="enhancers-fantom5-checkbox">
                        <input id="enhancers-fantom5-checkbox"
                               name="enhancers-fantom5-used"
                               type="checkbox" value="yes">
                        FANTOM5
                    </label>
                    <div id="enhancers-fantom5-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-fantom5-combine-mode" type="radio"
                                       id="enhancers-fantom5-all" value="all" disabled>
                                <label class="form-check-label" for="enhancers-fantom5-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-fantom5-combine-mode" type="radio"
                                       id="enhancers-fantom5-any" value="any" checked disabled>
                                <label class="form-check-label" for="enhancers-fantom5-any">
                                    Active in any of selected tissues</label>
                            </div>
                            <label for="enhancers-fantom5-kbs" class="col-form-label">
                                Kb upstream
                                <input name="enhancers-fantom5-kbs-upstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-fantom5-kbs-upstream" disabled>
                                Kb downstream
                                <input name="enhancers-fantom5-kbs-downstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-fantom5-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="enhancers-encode-checkbox">
                        <input id="enhancers-encode-checkbox"
                               name="enhancers-encode-used"
                               type="checkbox" value="yes">
                        ENCODE
                    </label>
                    <div id="enhancers-encode-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-encode-combine-mode" type="radio"
                                       id="enhancers-encode-all" value="all" disabled>
                                <label class="form-check-label" for="enhancers-encode-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-encode-combine-mode" type="radio"
                                       id="enhancers-encode-any" value="any" checked disabled>
                                <label class="form-check-label" for="enhancers-encode-any">
                                    Active in any of selected tissues</label>
                            </div>
                            <label for="enhancers-encode-kbs" class="col-form-label">
                                Kb upstream
                                <input name="enhancers-encode-kbs-upstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-encode-kbs-upstream" disabled>
                                Kb downstream
                                <input name="enhancers-encode-kbs-downstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-encode-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block accessible_chromatin %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-accessible-chromatin">
        Accessible chromatin
    </a>
    <div id="collapse-accessible-chromatin" class="collapse show">
        <div class="row">
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="accessible-chromatin-encode-checkbox">
                        <input id="accessible-chromatin-encode-checkbox"
                               name="accessible-chromatin-encode-used"
                               type="checkbox" value="yes">
                        ENCODE
                    </label>
                    <div id="accessible-chromatin-encode-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="accessible-chromatin-encode-combine-mode" type="radio"
                                       id="accessible-chromatin-encode-all" value="all" disabled>
                                <label class="form-check-label" for="accessible-chromatin-encode-all">
                                    Accessible in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="accessible-chromatin-encode-combine-mode" type="radio"
                                       id="accessible-chromatin-encode-any" value="any" checked disabled>
                                <label class="form-check-label" for="accessible-chromatin-encode-any">
                                    Accessible in any of selected tissues</label>
                            </div>
                            <label for="accessible-chromatin-encode-kbs" class="col-form-label">
                                Kb upstream
                                <input name="accessible-chromatin-encode-kbs-upstream" class="form-control"
                                       type="number" min="0"
                                       value="500" id="accessible-chromatin-encode-kbs-upstream" disabled>
                                Kb downstream
                                <input name="accessible-chromatin-encode-kbs-downstream" class="form-control"
                                       type="number" min="0"
                                       value="500" id="accessible-chromatin-encode-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block mirna_targets %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-mirna-targets">
        Micro RNA
    </a>
    <div id="collapse-mirna-targets" class="collapse show">
        <div class="row">
            <div class="card-body col-md-4">
                <div class="form-group">

                    <label for="mirna-mirtarbase-checkbox">
                        <input id="mirna-mirtarbase-checkbox"
                               name="mirna-mirtarbase-used"
                               type="checkbox" value="yes">
                        miRTarBase
                    </label>

                    <div id="mirna-mirtarbase-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            
                            <label for="mirna-mirtarbase-include-weak-checkbox">
                                <input id="mirna-mirtarbase-include-weak-checkbox"
                                        name="mirna-mirtarbase-include-weak"
                                        type="checkbox" value="yes">
                                    Include weak interactions
                            </label>
                                                    
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body col-md-4">
                <div class="form-group">
              
                    <label for="mirna-mirwalk-checkbox">
                        <input id="mirna-mirwalk-checkbox"
                               name="mirna-mirwalk-used"
                               type="checkbox" value="yes">
                        miRWalk
                    </label>


                    <div id="mirna-mirwalk-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <label for="mirna-mirwalk-minimal-confidence" class="col-form-label">
                                Minimal confidence (0-1)
                                <input name="mirna-mirwalk-minimal-confidence" class="form-control" type="float"
                                       min="0" value="0.9" id="mirna-mirwalk-minimal-confidence" disabled>
                            </label>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <div class="card-body col-md-4">
                <div class="form-group">
                    
                    <div id="mirna-targets-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                    
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="mirna-targets-combine-mode" type="radio"
                                       id="mirna-targets-combine-mode-all" value="all" disabled>
                                <label class="form-check-label" for="mirna-targets-combine-mode-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="mirna-targets-combine-mode" type="radio"
                                       id="mirna-targets-combine-mode-any" value="any" checked disabled>
                                <label class="form-check-label" for="mirna-targets-combine-mode-any">
                                    Active in any of selected tissues</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block summary_panel %}
    <div class="row align-items-top">
        <div class="col-md-4 " style="padding-left: 0">
            <div>
            <input type="submit" href="#footer" value="Query" id="submit-all" class="btn btn-success btn-lg"
                   role="button"
                   aria-disabled="true">
            <input type="button" id="download-result" class="btn btn-success btn-lg"
                   role="button" aria-disabled="true" value="Download result BED" disabled>
            </div><br><div>
            <input type="file" id="filter-vcf" accept="appliation/gzip, .vcf.gz, .vcf" 
                   role="button" aria-disabled="true" value="Filter VCF using result BED" disabled>
            </div>
        </div>
        <div class="col-md-8" style="">
            <div id="results-loading" class="text-center" style="border: dashed 1px; display:none">
                <img src="{{ url_for('static', filename='img/loading.gif') }}" class="w-25"/>
                <p>Computing...
                    <br>
                    (Please don't close page until finished)</p>
            </div>
            <div id="results-table" class="text-center" style="display:none">
            </div>
        </div>
    </div>
    
    <script>
        
        
        function trim_chr(chr){
            return chr;
        }
                    
        function trim_chr(chr) {
            return new String(chr).toLowerCase().replace('chr','');
        }
        
        function filterVcf(input_vcf_content, bed_content) {
                       
            //console.log('in_filter:'+input_vcf_content);
            //console.log('in_filter:'+bed_content);
                       
            var filtered_vcf_content="";
            var vcfLines = input_vcf_content.split(/\r\n|\n/);
            var intervals = bed_content.split(/\r\n|\n/);
            
            var vcf_index=0;
            var interval_index=0;
            while ( interval_index < intervals.length && vcf_index < vcfLines.length) {
            
                line = vcfLines[vcf_index];
                interval = intervals[interval_index].split('\t');
            
                if (line.trim()=="" || interval.length<3) {
                   break;
                }

                i_chr = parseInt(trim_chr(interval[0]));
                i_start = parseInt(interval[1]);
                i_end = parseInt(interval[2]);
                
                if (line.startsWith("#")) {
                    filtered_vcf_content += line+"\n";
                    vcf_index++;
                } else {
                    vcf_records = line.split('\t');
                    pos = parseInt(vcf_records[1]);
                    vcf_chr = parseInt(trim_chr(vcf_records[0]));
                    
                    if (vcf_chr < i_chr || 
                        (vcf_chr == i_chr && pos < i_start)) {
                        // vcf record < interval    =>    move to the next record
                        vcf_index++;

                    } else if ((vcf_chr == i_chr && pos >= i_end) ||
                               vcf_chr > i_chr) {
                        // vcf_record > interval    =>    move to the next interval
                        interval_index++;
                    } else {
                        // console.log(line + "\n" + interval + "\n" + vcf_chr+" "+pos + "\n" + i_chr+" "+i_start+" "+i_end +"\n" + (pos < i_end) + " " + (pos>=i_start))
                        
                        // variant in interval boundary
                        filtered_vcf_content += line+"\n";
                        vcf_index++;
                    }
                }
            }
                    
            return filtered_vcf_content;
        }
        
        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
        
        function handleFilterVcf(evt) {

            // download the result BED first
            var xhr = new XMLHttpRequest(); 
            xhr.open("GET", $SCRIPT_ROOT + "/api/download_last"); 
            xhr.responseType = "text";
            xhr.onload = function() {
                
                // skip if no file was selected
                if (evt.target.files.length < 1) {
                    return; 
                }
                
                var bed = xhr.response;
                //console.log('bed1: ' + bed);

                // then, load user's VCF
                var file = evt.target.files[0];
                var reader = new FileReader();
                reader.onload = function(f) {
                    
                    var vcf_content = f.target.result;
                    //console.log('bed2: ' + bed);
                    //console.log('vcf: '+vcf_content);

                    // do the filtering (intersection)
                    var filtered_vcf_content = filterVcf(vcf_content, bed);
                    //console.log('fvcf: '+filtered_vcf_content);
                    // and download result
                    download('filtered.vcf', filtered_vcf_content);
                };
                reader.readAsText(file);
            }
            xhr.send();
            
        }
    
        document.getElementById('filter-vcf').addEventListener('change', handleFilterVcf, false);
        
    </script>
    
{% endblock %}
