{% extends "structure.html" %}

{% block general_controls %}
    {{ super() }}
    <div class="col">
        <div class="float-right">

            <button class="switch close" id="genome-switch-button"
                    data-trigger="focus"
                    data-toggle="popover"
                    data-placement="left"
                    {# data-content="Select genome build"#} > 
                <input id="genome-switch" class="switch" type="checkbox">
                <label for="genome-switch" id="genome-switch-label" class="">Genome</label>
            </button>
        </div>
    </div>
{% endblock %}

{% block genes_section %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-genes">
        Genes
    </a>
    <div id="collapse-genes" class="form-group collapse show">
        <div class="row">
            <div class="card-body align-self-center col-md-6">
                <div class="form-group">
                    <h5><label for="select-genes">Select genes:</label></h5>
                    <div>
                        <select class="form-control" name="genes" id="select-genes" required></select>
                    </div>
                    <a class="ask-btn small text-success"
                       tabindex="0"
                       role="button"
                       data-trigger="focus"
                       data-toggle="popover"
                       data-placement="right"
                       data-html="true"
                       data-content="Holding [ctrl✲] key will prevent modal dialog from closing after selection">
                        [Tips]
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block tissues_section %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-tissues">
        Organs, tissues and cell types
    </a>
    <div id="collapse-tissues" class="form-group collapse show">
        <div class="row">
            <div class="card-body align-self-center col-md-6">
                <h5><label for="select-tissues">Select organs/tissues/cell types:<br/>
                </label></h5>
                <div>
                    <select class="form-control" name="tissues" id="select-tissues"></select>
                </div>
                <a class="ask-btn small text-success"
                   tabindex="0"
                   role="button"
                   data-trigger="focus"
                   data-toggle="popover"
                   data-placement="right"
                   data-html="true"
                   data-content="Because data is still not fully complete, symbols in parentheses are telling which sections are affected by chosen tissue/organ/cell type: <br /><br />
                                    Legend:<br />

                                    TSS - Transcription start sites <br />
                                    ENH_F5 - Enhancers -> FANTOM5 <br />
                                    ENH_EN - Enhancers -> ENCODE <br />
                                    CHRM - Accessible chromatin">
                    [Meaning of symbols in parentheses]
                </a><br />
                <a class="ask-btn small text-success"
                   tabindex="0"
                   role="button"
                   data-trigger="focus"
                   data-toggle="popover"
                   data-placement="right"
                   data-html="true"
                   data-content="Holding [ctrl✲] key will prevent modal dialog from closing after selection">
                    [Tips]
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block transcription_start_sites %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-transcription-start-sites">
        Transcription start sites
    </a>
    <div id="collapse-transcription-start-sites" class="collapse show">
        <div class="row">
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="transcription-start-sites-fantom5-checkbox">
                        <input id="transcription-start-sites-fantom5-checkbox"
                               name="transcription-fantom5-used"
                               type="checkbox" value="yes">
                        FANTOM5
                    </label>
                    {#                    <a class="ask-btn"#}
                    {#                       tabindex="0"#}
                    {#                       role="button"#}
                    {#                       data-trigger="focus"#}
                    {#                       data-toggle="popover"#}
                    {#                       data-placement="right"#}
                    {#                       data-content="There will be help here">#}
                    {#                        [?]#}
                    {#                    </a>#}
                    <div id="transcription-start-sites-fantom5-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="transcription-fantom5-combine-mode" type="radio"
                                       id="transcription-fantom5-all" value="all" disabled>
                                <label class="form-check-label" for="transcription-fantom5-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="transcription-fantom5-combine-mode" type="radio"
                                       id="transcription-fantom5-any" value="any" checked disabled>
                                <label class="form-check-label" for="transcription-fantom5-any">
                                    Active in any of selected tissues</label>
                            </div>
                            <label for="transcription-fantom5-kbs" class="col-form-label">
                                bps upstream
                                <input name="transcription-fantom5-kbs-upstream" class="form-control" type="number"
                                       min="0" value="3000" id="transcription-fantom5-kbs-upstream" disabled>
                                bps downstream
                                <input name="transcription-fantom5-kbs-downstream" class="form-control" type="number"
                                       min="0" value="100" id="transcription-fantom5-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block enhancers %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-enhancers">
        Enhancers
    </a>
    <div id="collapse-enhancers" class="collapse show">
        <div class="row">
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="enhancers-fantom5-checkbox">
                        <input id="enhancers-fantom5-checkbox"
                               name="enhancers-fantom5-used"
                               type="checkbox" value="yes">
                        FANTOM5
                    </label>
                    <div id="enhancers-fantom5-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-fantom5-combine-mode" type="radio"
                                       id="enhancers-fantom5-all" value="all" disabled>
                                <label class="form-check-label" for="enhancers-fantom5-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-fantom5-combine-mode" type="radio"
                                       id="enhancers-fantom5-any" value="any" checked disabled>
                                <label class="form-check-label" for="enhancers-fantom5-any">
                                    Active in any of selected tissues</label>
                            </div>
                            <label for="enhancers-fantom5-kbs" class="col-form-label">
                                Kb upstream
                                <input name="enhancers-fantom5-kbs-upstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-fantom5-kbs-upstream" disabled>
                                Kb downstream
                                <input name="enhancers-fantom5-kbs-downstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-fantom5-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="enhancers-encode-checkbox">
                        <input id="enhancers-encode-checkbox"
                               name="enhancers-encode-used"
                               type="checkbox" value="yes">
                        ENCODE
                    </label>
                    <div id="enhancers-encode-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-encode-combine-mode" type="radio"
                                       id="enhancers-encode-all" value="all" disabled>
                                <label class="form-check-label" for="enhancers-encode-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="enhancers-encode-combine-mode" type="radio"
                                       id="enhancers-encode-any" value="any" checked disabled>
                                <label class="form-check-label" for="enhancers-encode-any">
                                    Active in any of selected tissues</label>
                            </div>
                            <label for="enhancers-encode-kbs" class="col-form-label">
                                Kb upstream
                                <input name="enhancers-encode-kbs-upstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-encode-kbs-upstream" disabled>
                                Kb downstream
                                <input name="enhancers-encode-kbs-downstream" class="form-control" type="number"
                                       min="0" value="500" id="enhancers-encode-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block accessible_chromatin %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-accessible-chromatin">
        Accessible chromatin
    </a>
    <div id="collapse-accessible-chromatin" class="collapse show">
        <div class="row">
            <div class="card-body col-md-6">
                <div class="form-group">
                    <label for="accessible-chromatin-encode-checkbox">
                        <input id="accessible-chromatin-encode-checkbox"
                               name="accessible-chromatin-encode-used"
                               type="checkbox" value="yes">
                        ENCODE
                    </label>
                    <div id="accessible-chromatin-encode-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="accessible-chromatin-encode-combine-mode" type="radio"
                                       id="accessible-chromatin-encode-all" value="all" disabled>
                                <label class="form-check-label" for="accessible-chromatin-encode-all">
                                    Accessible in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="accessible-chromatin-encode-combine-mode" type="radio"
                                       id="accessible-chromatin-encode-any" value="any" checked disabled>
                                <label class="form-check-label" for="accessible-chromatin-encode-any">
                                    Accessible in any of selected tissues</label>
                            </div>
                            <label for="accessible-chromatin-encode-kbs" class="col-form-label">
                                Kb upstream
                                <input name="accessible-chromatin-encode-kbs-upstream" class="form-control"
                                       type="number" min="0"
                                       value="500" id="accessible-chromatin-encode-kbs-upstream" disabled>
                                Kb downstream
                                <input name="accessible-chromatin-encode-kbs-downstream" class="form-control"
                                       type="number" min="0"
                                       value="500" id="accessible-chromatin-encode-kbs-downstream" disabled>

                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block mirna_targets %}
    <a class="collapsed card-header bg-info card-link text-white" data-toggle="collapse"
       href="#collapse-mirna-targets">
        Micro RNA
    </a>
    <div id="collapse-mirna-targets" class="collapse show">
        <div class="row">
            <div class="card-body col-md-4">
                <div class="form-group">

                    <label for="mirna-mirtarbase-checkbox">
                        <input id="mirna-mirtarbase-checkbox"
                               name="mirna-mirtarbase-used"
                               type="checkbox" value="yes">
                        miRTarBase
                    </label>

                    <div id="mirna-mirtarbase-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            
                            <label for="mirna-mirtarbase-include-weak-checkbox">
                                <input id="mirna-mirtarbase-include-weak-checkbox"
                                        name="mirna-mirtarbase-include-weak"
                                        type="checkbox" value="yes">
                                    Include weak interactions
                            </label>
                                                    
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body col-md-4">
                <div class="form-group">
              
                    <label for="mirna-mirwalk-checkbox">
                        <input id="mirna-mirwalk-checkbox"
                               name="mirna-mirwalk-used"
                               type="checkbox" value="yes">
                        miRWalk
                    </label>


                    <div id="mirna-mirwalk-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                            <label for="mirna-mirwalk-minimal-confidence" class="col-form-label">
                                Minimal confidence (0-1)
                                <input name="mirna-mirwalk-minimal-confidence" class="form-control" type="float"
                                       min="0" value="0.9" id="mirna-mirwalk-minimal-confidence" disabled>
                            </label>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <div class="card-body col-md-4">
                <div class="form-group">
                    
                    <div id="mirna-targets-controls"
                         class="collapse hiden-controls">
                        <div class="col-md-12">
                    
                            <div class="form-check">
                                <input class="form-check-input"
                                       name="mirna-targets-combine-mode" type="radio"
                                       id="mirna-targets-combine-mode-all" value="all" disabled>
                                <label class="form-check-label" for="mirna-targets-combine-mode-all">
                                    Active in all selected tissues</label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input"
                                       name="mirna-targets-combine-mode" type="radio"
                                       id="mirna-targets-combine-mode-any" value="any" checked disabled>
                                <label class="form-check-label" for="mirna-targets-combine-mode-any">
                                    Active in any of selected tissues</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block summary_panel %}
    <div class="row align-items-top">
        <div class="col-md-4 " style="padding-left: 0">
            <div>
            <input type="submit" href="#footer" value="Query" id="submit-all" class="btn btn-success btn-lg"
                   role="button"
                   aria-disabled="true">
            <input type="button" id="download-result" class="btn btn-success btn-lg"
                   role="button" aria-disabled="true" value="Download result BED" disabled>
            </div><br><div>
            <input type="file" id="filter-vcf" accept=".vcf.gz, .tbi, .vcf" 
                   role="button" aria-disabled="true" value="Filter VCF using result BED" multiple disabled>
            </div>
        </div>
        <div class="col-md-8" style="">
            <div id="results-loading" class="text-center" style="border: dashed 1px; display:none">
                <img src="{{ url_for('static', filename='img/loading.gif') }}" class="w-25"/>
                <p>Computing...
                    <br>
                    (Please don't close page until finished)</p>
            </div>
            <div id="results-table" class="text-center" style="display:none">
            </div>
        </div>
    </div>
    

    <script>
     
        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
        
        
        function filterPlainTextVcf(input_vcf_content, intervals) {
                       
            //console.log('in_filter:'+input_vcf_content);
            //console.log('in_filter:'+bed_content);
            
            var trimChr = function(chr) { return new String(chr).toLowerCase().replace('chr',''); }
            
            var filtered_vcf_content="";
            var vcfLines = input_vcf_content.split(/\r\n|\n/);
            
            var vcf_index=0;
            var interval_index=0;
            while ( interval_index < intervals.length && vcf_index < vcfLines.length) {
            
                line = vcfLines[vcf_index];
                interval = intervals[interval_index];
            
                if (line.trim()=="" || interval.length<3) {
                   break;
                }

                i_chr = parseInt(trimChr(interval[0]));
                i_start = parseInt(interval[1]);
                i_end = parseInt(interval[2]);
                
                if (line.startsWith("#")) {
                    filtered_vcf_content += line+"\n";
                    vcf_index++;
                } else {
                    vcf_records = line.split('\t');
                    pos = parseInt(vcf_records[1]);
                    vcf_chr = parseInt(trimChr(vcf_records[0]));
                    
                    if (vcf_chr < i_chr || 
                        (vcf_chr == i_chr && pos < i_start)) {
                        // vcf record < interval    =>    move to the next record
                        vcf_index++;

                    } else if ((vcf_chr == i_chr && pos >= i_end) ||
                               vcf_chr > i_chr) {
                        // vcf_record > interval    =>    move to the next interval
                        interval_index++;
                    } else {
                        // console.log(line + "\n" + interval + "\n" + vcf_chr+" "+pos + "\n" + i_chr+" "+i_start+" "+i_end +"\n" + (pos < i_end) + " " + (pos>=i_start))
                        
                        // variant in interval boundary
                        filtered_vcf_content += line+"\n";
                        vcf_index++;
                    }
                }
            }
                    
            return filtered_vcf_content;
        }
        
        
        
        function makeVcfString(list) {
            var result = [];
            list.forEach(function(e) {
                result = result.concat(e);
            });
            return result.join('\n');
        }

        function filterTabixedVcfCallbackMerger(reader, bed) {
    
            var filteredVcfName = reader.theFile.name + ".remus_filtered.vcf"
            var filteredRecords = [];        
            var callbackCnt = 0;         
            
            reader.getHeader(function(x) {
                                filteredRecords[0] = x;
                                ++callbackCnt;
                                if (callbackCnt == bed.length+1) {
                                    download(filteredVcfName, makeVcfString(filteredRecords));
                                }
                            });
                 
            for (i=0; i<bed.length; i++) {
                reg = bed[i];
                reader.getRecords(reg[0], reg[1], reg[2], 
                                  (function () {
                                        var j = i;
                                        return function(x) {
                                            filteredRecords[j+1] = x;
                                            ++callbackCnt;
                                            if (callbackCnt == bed.length+1) {
                                                download(filteredVcfName, makeVcfString(filteredRecords));
                                            }
                                        }
                                   })() );
            }
        }

        
        function loadAndFilterTabixedVcf(files, bed) {
            
            var isTabi = function(f) {return f.name.split(".").slice(-1)[0] == "tbi";};                   
            var tabixFile = isTabi(files[0]) ? files[0] : files[1];
            var vcfFile = isTabi(files[1]) ? files[0] : files[1];

            // console.log("Tabix: " +tabixFile.name + "\nVCF: " + vcfFile.name);
            vcfR = new readBinaryVCF(tabixFile, vcfFile, 
                                    (function() {
                                        return function(vcfReader) {
                                                    return filterTabixedVcfCallbackMerger(vcfReader, bedRecords);
                                                }
                                    })());
        }
        
        function loadAndFilterPlainTextVcf(vcf, bedRecords) {
            
            var reader = new FileReader();
            reader.onload = function(f) {         
                // get file content     
                var vcf_content = f.target.result;
                // do the filtering 
                var filtered_vcf_content = filterPlainTextVcf(vcf_content, bedRecords);
                // and download result
                download(vcf.name+'.remus_filtered.vcf', filtered_vcf_content);
            };
            reader.readAsText(vcf);
        }
        
        function handleFilterVcf(evt) {

            // skip if no file was selected
            var files = evt.target.files;
            if (files.length < 1) {
                alert("Please select single uncompressed VCF file, or a pair of files: BGZipped VCF and its Tabix index.");
                return; 
            }
                
            // download the result BED first (while user selects VCF files)
            var xhr = new XMLHttpRequest(); 
            xhr.open("GET", $SCRIPT_ROOT + "/api/download_last"); 
            xhr.responseType = "text";
            xhr.onload = function() {
                
                var bed = xhr.response;
                //console.log('bed1: ' + bed);

                // parse bed file into matrix of coordinates
                bedRecords = [];
                bed.split(/\r\n|\n/).forEach(function(x) {
                                                r = x.split("\t")
                                                if (r.length>=3) {
                                                    bedRecords.push(r)
                                                } 
                                            });
                //console.log(bedRecords);


                // load and filter user's VCF
                if (files.length == 1) {   // single not-compressed VCF
                
                    loadAndFilterPlainTextVcf(files[0], bedRecords);
                
                } else if (files.length > 1) {  // filter BGZipped and Tabix indexed VCF
                    
                    loadAndFilterTabixedVcf(files, bed);
                    
                }
            }
            xhr.send();
            
        }

     
        document.getElementById('filter-vcf').addEventListener('change', handleFilterVcf, false);
        
    </script>
    
{% endblock %}
